<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>InscripciÃ³n en proceso</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <style>
    body { background:#f6f8fb; }
    .page-header { background:linear-gradient(135deg,#0d6efd 0%,#6610f2 100%); color:#fff; padding:1.25rem 0; margin-bottom:1rem; }
    .status-panel { position:fixed; left:0; right:0; bottom:0; background:#000000bf; color:#fff; padding:.75rem 1rem; }
  </style>
</head>
<body>
  <header class="page-header">
    <div class="container d-flex justify-content-between align-items-center">
      <h1 class="h5 mb-0">InscripciÃ³n en proceso</h1>
      <a href="index.html" class="btn btn-outline-light btn-sm"><i class="bi bi-arrow-left"></i> Volver al portal</a>
    </div>
  </header>

  <main class="container py-4">
    <div id="alertTop" class="alert alert-info d-flex align-items-center" role="alert">
      <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
      <div id="alertMsg">Tu inscripciÃ³n estÃ¡ siendo procesadaâ€¦</div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body text-center py-5">
        <div class="mb-3">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
        </div>
        <h2 class="h5 fw-bold mb-2" id="estadoTitulo">Esperando resultadoâ€¦</h2>
        <p class="text-muted mb-4" id="estadoDetalle">La cola estÃ¡ procesando tu tarea.</p>

        <div class="d-flex justify-content-center gap-2">
          <button id="btnVerificar" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#estadoModal">
            <i class="bi bi-search"></i> Verificar estado (vista rÃ¡pida)
          </button>
          <button id="btnForzarConsulta" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-repeat"></i> Forzar consulta ahora
          </button>
        </div>
      </div>
      <div class="card-footer small text-muted">
        <span>Cola: <strong id="lblCola">â€”</strong></span> â€¢
        <span>Tarea: <strong id="lblTarea">â€”</strong></span>
      </div>
    </div>
  </main>

  <!-- Panel inferior: actividad del polling -->
  <div class="status-panel d-none" id="statusPanel">
    <div class="container d-flex align-items-center">
      <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
      <div class="small" id="statusPanelMsg">Consultando estadoâ€¦</div>
    </div>
  </div>

  <!-- Modal Estado -->
  <div class="modal fade" id="estadoModal" tabindex="-1" aria-labelledby="estadoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="estadoModalLabel">Estado de inscripciÃ³n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="estadoModalAlert" class="alert alert-secondary d-flex align-items-center" role="alert">
            <div class="spinner-border me-2" role="status" aria-hidden="true"></div>
            <div>Consultandoâ€¦</div>
          </div>

          <dl class="row small mb-0" id="estadoModalDetails" style="display:none;">
            <dt class="col-4">Cola</dt><dd class="col-8" id="mCola">â€”</dd>
            <dt class="col-4">Tarea</dt><dd class="col-8" id="mTarea">â€”</dd>
            <dt class="col-4">HTTP</dt><dd class="col-8" id="mHttp">â€”</dd>
            <dt class="col-4">Estado</dt><dd class="col-8" id="mEstado">â€”</dd>
            <dt class="col-4">Mensaje</dt><dd class="col-8" id="mMensaje">â€”</dd>
            <dt class="col-4">Resultado</dt><dd class="col-8" id="mResultado">â€”</dd>
          </dl>
        </div>
        <div class="modal-footer">
          <button id="modalRecheckBtn" type="button" class="btn btn-outline-primary">Volver a consultar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== Config / estado inicial =====
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/'; }

    const cola    = sessionStorage.getItem('ultimaCola');
    const tareaId = sessionStorage.getItem('ultimaTareaId');
    const lastMsg = sessionStorage.getItem('ultimaMsg') || 'Procesandoâ€¦';

    document.getElementById('lblCola').textContent  = cola || 'â€”';
    document.getElementById('lblTarea').textContent = tareaId || 'â€”';
    document.getElementById('alertMsg').textContent = lastMsg;

    if (!cola || !tareaId) {
      document.getElementById('alertTop').className = 'alert alert-danger';
      document.getElementById('alertMsg').textContent = 'No se encontraron datos de la tarea. VolvÃ© al portal.';
    }

    // ===== Elementos UI =====
    const statusPanel    = document.getElementById('statusPanel');
    const statusPanelMsg = document.getElementById('statusPanelMsg');
    const estadoTitulo   = document.getElementById('estadoTitulo');
    const estadoDetalle  = document.getElementById('estadoDetalle');
    const alertTop       = document.getElementById('alertTop');
    const alertMsg       = document.getElementById('alertMsg');

    // BotÃ³n de recarga -> deberÃ¡ volverse check al completar
    const btnForzar = document.getElementById('btnForzarConsulta');
    const btnForzarIcon = btnForzar.querySelector('i'); // <i class="bi bi-arrow-repeat"></i>

    // Modal elements
    const estadoModalAlert   = document.getElementById('estadoModalAlert');
    const estadoModalDetails = document.getElementById('estadoModalDetails');
    const mCola = document.getElementById('mCola');
    const mTarea = document.getElementById('mTarea');
    const mHttp = document.getElementById('mHttp');
    const mEstado = document.getElementById('mEstado');
    const mMensaje = document.getElementById('mMensaje');
    const mResultado = document.getElementById('mResultado');

    // ===== Polling =====
    let pollingId = null;
    const BASE = 'http://127.0.0.1:8000';

    function showPanel(text, show=true) {
      statusPanelMsg.textContent = text || 'Consultando estadoâ€¦';
      statusPanel.classList.toggle('d-none', !show);
    }

    async function fetchEstado(cola, tareaId) {
      const url = `${BASE}/colas/${cola}/resultados_estados2/${tareaId}`;
      const res = await fetch(url, { headers: { "Authorization": "Bearer " + token } });
      let data = {};
      try { data = await res.json(); } catch (_) {}
      return { res, data };
    }

    function messageFrom(data, fallbackOk='Tarea completada', fallbackErr='OcurriÃ³ un error') {
      if (data?.resultado && typeof data.resultado === 'object') {
        return data.resultado.msg || data.resultado.error || data.mensaje || fallbackOk;
      }
      if (typeof data?.resultado === 'string') return data.resultado;
      return data?.mensaje || data?.error?.message || fallbackErr;
    }

    // ðŸ‘‰ Cambia solo el Ã­cono de recarga por un check cuando se completa
    function marcarBotonCheck() {
      btnForzarIcon.className = 'bi bi-check-circle-fill';
    }

    // ðŸ‘‰ Cambia el Ã­cono del alert superior a un check (opcional, no requerido)
    function marcarAlertCheck() {
      alertTop.className = 'alert alert-success d-flex align-items-center';
      alertTop.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i><div id="alertMsg">Â¡Todo listo!</div>`;
    }

    async function cicloPolling() {
      if (!cola || !tareaId) return;
      try {
        showPanel('Consultando estadoâ€¦', true);
        const { res, data } = await fetchEstado(cola, tareaId);

        if (res.status === 201 || data?.estado === 'completado') {
          // Completado
          estadoTitulo.textContent = 'InscripciÃ³n completada';
          estadoDetalle.textContent = messageFrom(data, 'InscripciÃ³n completada correctamente');

          // Actualizamos el alert y el Ã­cono del botÃ³n de recarga -> check âœ…
          marcarAlertCheck();          // si NO quieres tocar el alert, comenta esta lÃ­nea
          marcarBotonCheck();          // <<--- lo que pediste

          clearInterval(pollingId);
          showPanel('', false);
          return;
        }

        if (res.status === 202 || data?.estado === 'espera' || data?.estado === 'pendiente') {
          // Sigue en proceso
          const base = data?.mensaje || 'Procesando';
          estadoTitulo.textContent = 'Procesandoâ€¦';
          estadoDetalle.textContent = base;
          showPanel(base + ' â€¦', true);
          return;
        }

        if (res.status >= 400 || data?.estado === 'error') {
          // Error
          estadoTitulo.textContent = 'Error en la inscripciÃ³n';
          estadoDetalle.textContent = messageFrom(data, 'â€”', 'OcurriÃ³ un error al procesar la tarea');

          // En error NO cambiamos el Ã­cono a check (se mantiene el de recarga)
          document.getElementById('alertTop').className = 'alert alert-danger d-flex align-items-center';
          document.getElementById('alertTop').innerHTML =
            `<i class="bi bi-exclamation-triangle-fill me-2"></i><div id="alertMsg">Se produjo un error.</div>`;

          clearInterval(pollingId);
          showPanel('', false);
          return;
        }

        // Estado desconocido
        estadoTitulo.textContent = 'Estado desconocido';
        estadoDetalle.textContent = `Estado: ${data?.estado || 'sin estado'}`;
        clearInterval(pollingId);
        showPanel('', false);

      } catch (e) {
        console.error('Polling error:', e);
        estadoTitulo.textContent = 'Error de conexiÃ³n';
        estadoDetalle.textContent = 'No fue posible consultar el estado.';
        clearInterval(pollingId);
        showPanel('', false);
      }
    }

    // Iniciar polling (cada 1.5 s)
    if (cola && tareaId) {
      cicloPolling();
      pollingId = setInterval(cicloPolling, 1500);
    }

    // BotÃ³n "Forzar consulta ahora" (no afecta el interval, solo dispara una vez)
    btnForzar.addEventListener('click', cicloPolling);

    // ===== Modal: consulta puntual independiente =====
    async function actualizarModal() {
      estadoModalAlert.className = 'alert alert-secondary d-flex align-items-center';
      estadoModalAlert.innerHTML = `<div class="spinner-border me-2" role="status" aria-hidden="true"></div><div>Consultandoâ€¦</div>`;
      estadoModalDetails.style.display = 'none';

      if (!cola || !tareaId) {
        estadoModalAlert.className = 'alert alert-danger';
        estadoModalAlert.textContent = 'No hay tarea para consultar.';
        return;
      }

      try {
        const { res, data } = await fetchEstado(cola, tareaId);
        mCola.textContent = cola; mTarea.textContent = tareaId;
        mHttp.textContent = res.status;
        mEstado.textContent = data?.estado || 'â€”';
        mMensaje.textContent = messageFrom(data) || 'â€”';
        mResultado.textContent = typeof data?.resultado === 'object' ? JSON.stringify(data.resultado) : (data?.resultado || 'â€”');

        if (res.status === 201 || data?.estado === 'completado') {
          estadoModalAlert.className = 'alert alert-success';
          estadoModalAlert.textContent = 'Completado';
        } else if (res.status === 202 || data?.estado === 'espera' || data?.estado === 'pendiente') {
          estadoModalAlert.className = 'alert alert-info';
          estadoModalAlert.textContent = 'En proceso';
        } else if (res.status >= 400 || data?.estado === 'error') {
          estadoModalAlert.className = 'alert alert-danger';
          estadoModalAlert.textContent = 'Error';
        } else {
          estadoModalAlert.className = 'alert alert-secondary';
          estadoModalAlert.textContent = 'Estado desconocido';
        }

        estadoModalDetails.style.display = '';
      } catch (e) {
        estadoModalAlert.className = 'alert alert-danger';
        estadoModalAlert.textContent = 'Error al consultar.';
      }
    }

    const estadoModalEl = document.getElementById('estadoModal');
    estadoModalEl.addEventListener('show.bs.modal', actualizarModal);
    document.getElementById('modalRecheckBtn').addEventListener('click', actualizarModal);
  </script>
</body>
</html>
